name: Run Pastebin publisher (every 2 hours)

on:
  schedule:
    # Every 2 hours at minute 0 (00:00, 02:00, 04:00, ...)
    - cron: '0 */2 * * *'
  workflow_dispatch:
    inputs:
      repeat:
        description: 'How many times to run Pastebin in this workflow run'
        required: false
        default: '1'

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest

    env:
      CREDENTIALS_CSV: credentials.csv
      CREDENTIAL_STATE_JSON: csv_credentials_state.json
      SUBMISSIONS_CSV: submissions.csv

      SOURCE_IP: 11.11.X.11

      # IMPORTANT: set this to the exact key from publishers.SCRIPTS
      # that corresponds to pastebin_post.py, e.g. "Pastebin post"
      PUBLISHER_LABEL: "Pastebin post"

      # For scheduled runs this will be "1" by default,
      # but you can override from the manual dispatch.
      REPEAT: ${{ github.event.inputs.repeat || '1' }}

      # Single big secret containing your whole .env
      ALL_ENV_VARS: ${{ secrets.ALL_ENV_VARS }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Write .env from ALL_ENV_VARS
        run: |
          echo "$ALL_ENV_VARS" > .env

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Run automation runner (Pastebin only)
        run: python automation_runner.py

      - name: Commit state and logs
        if: github.ref == 'refs/heads/main'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add csv_credentials_state.json submissions.csv || true
          git diff --cached --quiet || git commit -m "Update state & submissions (Pastebin)"
          git push
