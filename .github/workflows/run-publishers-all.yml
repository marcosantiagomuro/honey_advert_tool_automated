name: Run all publishers (twice daily)

on:
  schedule:
    # Runs at 06:00 and 18:00 UTC every day
    - cron: '0 6,18 * * *'
  workflow_dispatch:
    inputs:
      publisher:
        description: 'Publisher label (exact key from publishers.SCRIPTS) or "all"'
        required: false
        default: 'all'
      repeat:
        description: 'How many times to run the chosen publisher(s)'
        required: false
        default: '1'

permissions:
  contents: write   # needed if you want to commit state/logs back to the repo

jobs:
  run:
    runs-on: ubuntu-latest

    env:
      # Files in your repo
      CREDENTIALS_CSV: credentials.csv
      CREDENTIAL_STATE_JSON: csv_credentials_state.json
      SUBMISSIONS_CSV: submissions.csv

      SOURCE_IP: 146.190.154.190

      # For scheduled runs this is effectively "all" / "1"
      PUBLISHER_LABEL: ${{ github.event.inputs.publisher || 'all' }}
      REPEAT: ${{ github.event.inputs.repeat || '1' }}

      # Single big secret containing your whole .env
      ALL_ENV_VARS: ${{ secrets.ALL_ENV_VARS }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Write .env from ALL_ENV_VARS
        run: |
          echo "$ALL_ENV_VARS" > .env

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Run automation runner (all publishers)
        run: python automation_runner.py

      # Optional: commit updated state & log
      - name: Commit state and logs
        if: github.ref == 'refs/heads/main'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add csv_credentials_state.json submissions.csv || true
          git diff --cached --quiet || git commit -m "Update state & submissions (all publishers)"
          git push
